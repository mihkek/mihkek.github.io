<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Finance Distributor</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            padding: 16px;
            background: #f5f5f5;
        }
        .container {
            max-width: 400px;
            margin: 0 auto;
        }
        .input-group {
            margin-bottom: 20px;
        }
        input {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            box-sizing: border-box;
        }
        button {
            width: 100%;
            padding: 12px;
            background: #2481cc;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
        }
        .category {
            display: flex;
            justify-content: space-between;
            margin: 8px 0;
            padding: 8px;
            background: white;
            border-radius: 6px;
        }
        .result-section {
            margin-top: 20px;
            display: none;
        }
        .category-config {
    background: white;
    padding: 12px;
    margin: 8px 0;
    border-radius: 8px;
    border: 1px solid #e0e0e0;
}

.category-name {
    font-weight: bold;
    margin-bottom: 8px;
}

.inputs {
    display: flex;
    gap: 8px;
}

.inputs input {
    flex: 1;
    padding: 8px;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 14px;
}

.balance-positive {
    border-left: 4px solid #4CAF50;
}

.balance-negative {
    border-left: 4px solid #f44336;
}
.category-config {
    background: white;
    padding: 12px;
    margin: 8px 0;
    border-radius: 8px;
    border: 1px solid #e0e0e0;
}

.category-name {
    font-weight: bold;
    margin-bottom: 12px;
    font-size: 14px;
}

.inputs {
    display: flex;
    gap: 12px;
}

.input-with-label {
    flex: 1;
    display: flex;
    flex-direction: column;
}

.input-with-label label {
    font-size: 12px;
    color: #666;
    margin-bottom: 4px;
    font-weight: 500;
}

.inputs input {
    padding: 8px;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 14px;
    width: 100%;
    box-sizing: border-box;
}

.balance-positive {
    border-left: 4px solid #4CAF50;
}

.balance-negative {
    border-left: 4px solid #f44336;
}

.summary .category {
    background: #e8f5e8;
    border-left: 4px solid #4CAF50;
}
    </style>
</head>
<body>
    <div class="container">
        <h2>üí∞ –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –¥–æ—Ö–æ–¥–æ–≤</h2>
        
        <div class="input-group">
            <label>–û–±—â–∞—è —Å—É–º–º–∞ –¥–æ—Ö–æ–¥–∞:</label>
            <input type="number" id="totalIncome" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É" value="314784">
        </div>

        <h3>–ë–∞–∑–æ–≤—ã–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏:</h3>
        <div id="categoriesConfig">
            <!-- –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ –±—É–¥—É—Ç –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è –∑–¥–µ—Å—å -->
        </div>
        
        <button onclick="calculate()">–†–∞—Å—Å—á–∏—Ç–∞—Ç—å</button>
        
        <div id="distributionResult" class="result-section">
            <h3>–†–µ–∑—É–ª—å—Ç–∞—Ç —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è:</h3>
            <div id="categoriesList"></div>
        </div>
    </div>

 <script>
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram Web App
    Telegram.WebApp.ready();
    Telegram.WebApp.expand();
    Telegram.WebApp.enableClosingConfirmation();
    Telegram.WebApp.setHeaderColor('#2481cc');
    Telegram.WebApp.setBackgroundColor('#f5f5f5');

    // –ë–∞–∑–æ–≤–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
    const defaultConfig = {
        categories: [
            { id: 'house', name: 'üè† –î–æ–º', limit: 10000, spent: 10000 },
            { id: 'car', name: 'üöó –ú–∞—à–∏–Ω–∞', limit: 38000, spent: 38000 },
            { id: 'longTerm', name: 'üìà –î–æ–ª–≥–æ—Å—Ä–æ–∫', limit: 45000, spent: 45000 },
            { id: 'start', name: 'üöÄ –°—Ç–∞—Ä—Ç', limit: 10000, spent: 10000 },
            { id: 'oper', name: 'üíº –û–ø–µ—Ä', limit: 45000, spent: 45000 },
            { id: 'wife', name: 'üë© –ñ–µ–Ω–∞', limit: 42000, spent: 42000 },
            { id: 'free', name: 'üíé –°–≤–æ–±–æ–¥–Ω–æ', limit: 40000, spent: 40000 },
            { id: 'hata', name: 'üè° –•–ê–¢–ê', limit: 20000, spent: 20000 },
            { id: 'home', name: 'üè† –î–æ–º–æ–π', limit: 10000, spent: 10000 }
        ],
        extraReserve: 0
    };

    let config = { ...defaultConfig };

    // –ù–∞–¥–µ–∂–Ω–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
    function saveToStorage() {
        const data = {
            categories: config.categories,
            lastIncome: document.getElementById('totalIncome').value,
            timestamp: new Date().toISOString(),
            version: '1.0'
        };
        
        // –°–ø–æ—Å–æ–± 1: Telegram WebApp Data Storage (–Ω–∞–¥–µ–∂–Ω—ã–π)
        try {
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–∞–∂–¥—É—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é –æ—Ç–¥–µ–ª—å–Ω–æ –¥–ª—è –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏
            data.categories.forEach((category, index) => {
                Telegram.WebApp.CloudStorage.setItem(`cat_${category.id}`, JSON.stringify(category));
            });
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ–±—â–∏–µ –¥–∞–Ω–Ω—ã–µ
            Telegram.WebApp.CloudStorage.setItem('finance_config', JSON.stringify(data));
            console.log('Data saved to CloudStorage');
        } catch (e) {
            console.log('CloudStorage error:', e);
        }
        
        // –°–ø–æ—Å–æ–± 2: LocalStorage –∫–∞–∫ —Ä–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è
        try {
            localStorage.setItem('finance_data', JSON.stringify(data));
            console.log('Data saved to localStorage');
        } catch (e) {
            console.error('localStorage error:', e);
        }
        
        // –°–ø–æ—Å–æ–± 3: SessionStorage –¥–ª—è —Ç–µ–∫—É—â–µ–π —Å–µ—Å—Å–∏–∏
        try {
            sessionStorage.setItem('finance_data', JSON.stringify(data));
        } catch (e) {}
    }

    // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö —Å –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞–º–∏
    function loadFromStorage() {
        let loadedData = null;
        
        // –ü—Ä–æ–±—É–µ–º –≤—Å–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏ –≤ –ø–æ—Ä—è–¥–∫–µ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞
        const sources = [
            { name: 'CloudStorage', tryLoad: tryLoadCloudStorage },
            { name: 'localStorage', tryLoad: tryLoadLocalStorage },
            { name: 'sessionStorage', tryLoad: tryLoadSessionStorage }
        ];
        
        // –ü—Ä–æ–±—É–µ–º –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑ –∫–∞–∂–¥–æ–≥–æ –∏—Å—Ç–æ—á–Ω–∏–∫–∞
        for (let source of sources) {
            loadedData = source.tryLoad();
            if (loadedData) {
                console.log(`Data loaded from ${source.name}`);
                applyLoadedData(loadedData);
                return;
            }
        }
        
        console.log('No saved data found, using defaults');
    }

    function tryLoadCloudStorage() {
        try {
            // –ü—Ä–æ–±—É–µ–º –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑ CloudStorage
            let cloudData = null;
            
            // –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–±—É–µ–º –∑–∞–≥—Ä—É–∑–∏—Ç—å –æ–±—â–∏–π –∫–æ–Ω—Ñ–∏–≥
            Telegram.WebApp.CloudStorage.getItem('finance_config', (err, value) => {
                if (!err && value) {
                    cloudData = JSON.parse(value);
                }
            });
            
            // –ï—Å–ª–∏ –Ω–µ—Ç –æ–±—â–µ–≥–æ –∫–æ–Ω—Ñ–∏–≥–∞, –ø—Ä–æ–±—É–µ–º —Å–æ–±—Ä–∞—Ç—å –∏–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–π
            if (!cloudData) {
                const categories = [];
                config.categories.forEach(cat => {
                    Telegram.WebApp.CloudStorage.getItem(`cat_${cat.id}`, (err, value) => {
                        if (!err && value) {
                            categories.push(JSON.parse(value));
                        }
                    });
                });
                if (categories.length > 0) {
                    cloudData = { categories: categories };
                }
            }
            
            return cloudData;
        } catch (e) {
            return null;
        }
    }

    function tryLoadLocalStorage() {
        try {
            const data = localStorage.getItem('finance_data');
            return data ? JSON.parse(data) : null;
        } catch (e) {
            return null;
        }
    }

    function tryLoadSessionStorage() {
        try {
            const data = sessionStorage.getItem('finance_data');
            return data ? JSON.parse(data) : null;
        } catch (e) {
            return null;
        }
    }

    function applyLoadedData(data) {
        if (data && data.categories) {
            // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ —Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏, –∫–æ—Ç–æ—Ä—ã–µ –µ—Å—Ç—å –≤ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
            data.categories.forEach(savedCat => {
                const existingCat = config.categories.find(cat => cat.id === savedCat.id);
                if (existingCat) {
                    existingCat.limit = savedCat.limit || existingCat.limit;
                    existingCat.spent = savedCat.spent || existingCat.spent;
                }
            });
            renderCategories();
        }
        if (data && data.lastIncome) {
            document.getElementById('totalIncome').value = data.lastIncome;
        }
    }

    // –§—É–Ω–∫—Ü–∏—è —Å–±—Ä–æ—Å–∞ –¥–∞–Ω–Ω—ã—Ö
    function resetData() {
        if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —Å–±—Ä–æ—Å–∏—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –∫ –Ω–∞—á–∞–ª—å–Ω—ã–º –∑–Ω–∞—á–µ–Ω–∏—è–º?')) {
            config = { ...defaultConfig };
            document.getElementById('totalIncome').value = '';
            renderCategories();
            saveToStorage(); // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–±—Ä–æ—à–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
            Telegram.WebApp.showAlert('–î–∞–Ω–Ω—ã–µ —Å–±—Ä–æ—à–µ–Ω—ã –∫ –Ω–∞—á–∞–ª—å–Ω—ã–º –∑–Ω–∞—á–µ–Ω–∏—è–º');
        }
    }

    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
    function renderCategories() {
        const container = document.getElementById('categoriesConfig');
        let html = '';
        
        config.categories.forEach((category, index) => {
            html += `
                <div class="category-config">
                    <div class="category-name">${category.name}</div>
                    <div class="inputs">
                        <div class="input-with-label">
                            <label>–õ–∏–º–∏—Ç</label>
                            <input type="number" 
                                   id="limit_${category.id}" 
                                   value="${category.limit}" 
                                   placeholder="–õ–∏–º–∏—Ç"
                                   onchange="updateCategory('${category.id}')">
                        </div>
                        <div class="input-with-label">
                            <label>–ü–æ—Ç—Ä–∞—á–µ–Ω–æ</label>
                            <input type="number" 
                                   id="spent_${category.id}" 
                                   value="${category.spent}" 
                                   placeholder="–ü–æ—Ç—Ä–∞—á–µ–Ω–æ"
                                   onchange="updateCategory('${category.id}')">
                        </div>
                    </div>
                </div>
            `;
        });
        
        container.innerHTML = html;
    }

    // –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –ø–æ–ª–µ–π
    function updateCategory(categoryId) {
        const category = config.categories.find(cat => cat.id === categoryId);
        if (category) {
            category.limit = parseInt(document.getElementById(`limit_${categoryId}`).value) || 0;
            category.spent = parseInt(document.getElementById(`spent_${categoryId}`).value) || 0;
            saveToStorage();
        }
    }

    function calculate() {
        const totalIncome = parseInt(document.getElementById('totalIncome').value);
        if (!totalIncome || totalIncome <= 0) {
            alert('–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Å—É–º–º—É –¥–æ—Ö–æ–¥–∞');
            return;
        }

        // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –æ—Å—Ç–∞—Ç–∫–∏ –ø–æ –∫–∞–∂–¥–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
        const categoriesWithBalance = config.categories.map(category => {
            const balance = category.limit - category.spent;
            const toSave = Math.max(0, balance);
            return {
                ...category,
                balance: balance,
                toSave: toSave
            };
        });

        // –û–±—â–∞—è —Å—É–º–º–∞ –£–ñ–ï –ø–æ—Ç—Ä–∞—á–µ–Ω–Ω—ã—Ö —Å—Ä–µ–¥—Å—Ç–≤
        const totalAlreadySpent = config.categories.reduce((sum, cat) => sum + cat.spent, 0);
        
        // –û–±—â–∞—è —Å—É–º–º–∞, –∫–æ—Ç–æ—Ä—É—é –Ω—É–∂–Ω–æ –î–û–õ–û–ñ–ò–¢–¨ –¥–æ –ª–∏–º–∏—Ç–æ–≤
        const totalToSave = categoriesWithBalance.reduce((sum, cat) => sum + cat.toSave, 0);
        
        // –ü–†–ê–í–ò–õ–¨–ù–´–ô —Ä–∞—Å—á–µ—Ç: (–¥–æ—Ö–æ–¥ - —É–∂–µ –ø–æ—Ç—Ä–∞—á–µ–Ω–æ - –Ω—É–∂–Ω–æ –¥–æ–ª–æ–∂–∏—Ç—å) + —Å–≤–µ—Ä—Ö–æ—Å—Ç–∞—Ç–æ–∫
        const remainingAfterBasics = (totalIncome - totalAlreadySpent - totalToSave) + config.extraReserve;
        
        // –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –æ—Å—Ç–∞—Ç–∫–∞ –Ω–∞ 3 –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
        const distribution = remainingAfterBasics > 0 ? remainingAfterBasics / 3 : 0;
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ—Å–ª–µ —Ä–∞—Å—á–µ—Ç–∞
        saveToStorage();
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
        displayResults(categoriesWithBalance, totalIncome, totalAlreadySpent, totalToSave, remainingAfterBasics, distribution);
    }

    function displayResults(categories, totalIncome, totalAlreadySpent, totalToSave, remainingAfterBasics, distribution) {
        const resultDiv = document.getElementById('distributionResult');
        const categoriesList = document.getElementById('categoriesList');
        
        resultDiv.style.display = 'block';
        
        let html = `
            <div class="summary">
                <div class="category"><span>üí∞ –û–±—â–∏–π –¥–æ—Ö–æ–¥:</span><span>${formatMoney(totalIncome)}</span></div>
                <div class="category"><span>üí∏ –£–∂–µ –ø–æ—Ç—Ä–∞—á–µ–Ω–æ:</span><span>${formatMoney(totalAlreadySpent)}</span></div>
                <div class="category"><span>üì• –ù—É–∂–Ω–æ –¥–æ–ª–æ–∂–∏—Ç—å –¥–æ –ª–∏–º–∏—Ç–æ–≤:</span><span>${formatMoney(totalToSave)}</span></div>
                <div class="category"><span>üéØ –°–≤–æ–±–æ–¥–Ω—ã–π –æ—Å—Ç–∞—Ç–æ–∫:</span><span>${formatMoney(remainingAfterBasics)}</span></div>
            </div>
            
            <h4>–ë–∞–∑–æ–≤—ã–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ (–õ–∏–º–∏—Ç / –ü–æ—Ç—Ä–∞—á–µ–Ω–æ / –ö –æ—Ç–ª–æ–∂–∏—Ç—å):</h4>
        `;
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–∞–∂–¥—É—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é
        categories.forEach(cat => {
            const status = cat.balance >= 0 ? '‚úÖ' : '‚ùå';
            const balanceClass = cat.balance >= 0 ? 'balance-positive' : 'balance-negative';
            html += `
                <div class="category ${balanceClass}">
                    <span>${cat.name}: ${formatMoney(cat.limit)} / ${formatMoney(cat.spent)}</span>
                    <span>${status} ${formatMoney(cat.toSave)}</span>
                </div>
            `;
        });
        
        html += `<h4>–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Å–≤–æ–±–æ–¥–Ω—ã—Ö —Å—Ä–µ–¥—Å—Ç–≤:</h4>`;
        
        if (distribution > 0) {
            html += `
                <div class="category"><span>üöó –ú–∞—à–∏–Ω–∞:</span><span>${formatMoney(distribution)}</span></div>
                <div class="category"><span>üìà –ò–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏:</span><span>${formatMoney(distribution)}</span></div>
                <div class="category"><span>üíé –°–≤–æ–±–æ–¥–Ω—ã–µ:</span><span>${formatMoney(distribution)}</span></div>
            `;
        } else {
            html += `<p>‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤ –¥–ª—è —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è</p>`;
        }
        
        // –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É —Å–±—Ä–æ—Å–∞
        html += `
            <div style="margin-top: 20px; text-align: center;">
                <button onclick="resetData()" style="background: #ff4444; padding: 8px 16px; font-size: 14px;">
                    üîÑ –°–±—Ä–æ—Å–∏—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ
                </button>
            </div>
        `;
        
        categoriesList.innerHTML = html;
        
        // –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤ Telegram
        Telegram.WebApp.showAlert(`–†–∞—Å—á–µ—Ç –∑–∞–≤–µ—Ä—à–µ–Ω! –°–≤–æ–±–æ–¥–Ω—ã—Ö —Å—Ä–µ–¥—Å—Ç–≤: ${formatMoney(remainingAfterBasics)}`);
        
        // –ê–≤—Ç–æ–ø—Ä–æ–∫—Ä—É—Ç–∫–∞ –∫ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º
        resultDiv.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    function formatMoney(amount) {
        return new Intl.NumberFormat('ru-RU').format(Math.round(amount)) + ' ‚ÇΩ';
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    renderCategories();
    loadFromStorage();
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
    Telegram.WebApp.onEvent('viewportChanged', saveToStorage);
    Telegram.WebApp.onEvent('closing', saveToStorage);
</script>
</body>
</html>
