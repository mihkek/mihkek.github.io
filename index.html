<script>
    const STORAGE_VERSION = '1.4';
    const defaultConfig = {
        categories: [
            { id: 'house', name: 'üè† –î–æ–º', limit: 10000, spent: 0 },
            { id: 'car', name: 'üöó –ú–∞—à–∏–Ω–∞', limit: 38000, spent: 0 },
            { id: 'longTerm', name: 'üìà –î–æ–ª–≥–æ—Å—Ä–æ–∫', limit: 45000, spent: 0 },
            { id: 'start', name: 'üöÄ –°—Ç–∞—Ä—Ç', limit: 10000, spent: 0 },
            { id: 'oper', name: 'üíº –û–ø–µ—Ä', limit: 45000, spent: 0 },
            { id: 'wife', name: 'üë© –ñ–µ–Ω–∞', limit: 42000, spent: 0 },
            { id: 'free', name: 'üíé –°–≤–æ–±–æ–¥–Ω–æ', limit: 40000, spent: 0 },
            { id: 'hata', name: 'üè° –•–ê–¢–ê', limit: 20000, spent: 0 },
            { id: 'home', name: 'üè† –î–æ–º–æ–π', limit: 10000, spent: 0 }
        ],
        extraReserve: 0
    };

    let config = JSON.parse(JSON.stringify(defaultConfig));

    Telegram.WebApp.ready();
    Telegram.WebApp.expand();
    Telegram.WebApp.enableClosingConfirmation();
    Telegram.WebApp.setHeaderColor('#2481cc');
    Telegram.WebApp.setBackgroundColor('#f5f5f5');

    // –ü–†–û–°–¢–û–ï –ò –ù–ê–î–ï–ñ–ù–û–ï –°–û–•–†–ê–ù–ï–ù–ò–ï
    function saveToStorage() {
        const data = {
            categories: config.categories,
            lastIncome: document.getElementById('totalIncome').value,
            bonusAmount: document.getElementById('bonusAmount').value,
            timestamp: new Date().toISOString(),
            version: STORAGE_VERSION
        };
        
        // –¢–û–õ–¨–ö–û localStorage - —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞–¥–µ–∂–Ω–æ
        try {
            localStorage.setItem('finance_data', JSON.stringify(data));
            console.log('Data saved successfully');
        } catch (e) {
            console.error('Save error:', e);
        }
    }

    // –ü–†–û–°–¢–ê–Ø –ó–ê–ì–†–£–ó–ö–ê
    function loadFromStorage() {
        try {
            const savedData = localStorage.getItem('finance_data');
            if (savedData) {
                const data = JSON.parse(savedData);
                applyLoadedData(data);
                console.log('Data loaded successfully');
            }
        } catch (e) {
            console.error('Load error:', e);
        }
    }

    function applyLoadedData(data) {
        if (data && data.categories) {
            config.categories = data.categories.map(savedCat => {
                const defaultCat = defaultConfig.categories.find(c => c.id === savedCat.id);
                return {
                    id: savedCat.id,
                    name: savedCat.name || (defaultCat ? defaultCat.name : ''),
                    limit: savedCat.limit || (defaultCat ? defaultCat.limit : 0),
                    spent: savedCat.spent || 0
                };
            });
            renderCategories();
        }
        if (data && data.lastIncome) {
            document.getElementById('totalIncome').value = data.lastIncome;
        }
        if (data && data.bonusAmount) {
            document.getElementById('bonusAmount').value = data.bonusAmount;
        }
    }

    // –û—Å—Ç–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π...
    function resetData() {
        if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —Å–±—Ä–æ—Å–∏—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –∫ –Ω–∞—á–∞–ª—å–Ω—ã–º –∑–Ω–∞—á–µ–Ω–∏—è–º?')) {
            config = JSON.parse(JSON.stringify(defaultConfig));
            document.getElementById('totalIncome').value = '';
            document.getElementById('bonusAmount').value = '';
            document.getElementById('bonusResult').style.display = 'none';
            document.getElementById('distributionResult').style.display = 'none';
            renderCategories();
            saveToStorage();
            Telegram.WebApp.showAlert('–î–∞–Ω–Ω—ã–µ —Å–±—Ä–æ—à–µ–Ω—ã –∫ –Ω–∞—á–∞–ª—å–Ω—ã–º –∑–Ω–∞—á–µ–Ω–∏—è–º');
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
    }

    function renderCategories() {
        const container = document.getElementById('categoriesConfig');
        container.innerHTML = config.categories.map(category => `
            <div class="category-config">
                <div class="category-name">${category.name}</div>
                <div class="inputs">
                    <div class="input-with-label">
                        <label>–õ–∏–º–∏—Ç</label>
                        <input type="number" 
                               id="limit_${category.id}" 
                               value="${category.limit}" 
                               placeholder="–õ–∏–º–∏—Ç"
                               onchange="updateCategory('${category.id}', 'limit', this.value)">
                    </div>
                    <div class="input-with-label">
                        <label>–ü–æ—Ç—Ä–∞—á–µ–Ω–æ</label>
                        <input type="number" 
                               id="spent_${category.id}" 
                               value="${category.spent}" 
                               placeholder="–ü–æ—Ç—Ä–∞—á–µ–Ω–æ"
                               onchange="updateCategory('${category.id}', 'spent', this.value)">
                    </div>
                </div>
            </div>
        `).join('');
    }

    function updateCategory(categoryId, field, value) {
        const category = config.categories.find(cat => cat.id === categoryId);
        if (category) {
            category[field] = parseInt(value) || 0;
            saveToStorage();
        }
    }

    function calculate() {
        const totalIncome = parseInt(document.getElementById('totalIncome').value);
        if (!totalIncome || totalIncome <= 0) {
            alert('–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Å—É–º–º—É –¥–æ—Ö–æ–¥–∞');
            return;
        }

        const categoriesWithBalance = config.categories.map(category => ({
            ...category,
            balance: category.limit - category.spent,
            toSave: Math.max(0, category.limit - category.spent)
        }));

        const totalAlreadySpent = config.categories.reduce((sum, cat) => sum + cat.spent, 0);
        const totalToSave = categoriesWithBalance.reduce((sum, cat) => sum + cat.toSave, 0);
        const remainingAfterBasics = totalIncome - totalAlreadySpent - totalToSave + config.extraReserve;
        const distribution = remainingAfterBasics > 0 ? remainingAfterBasics / 3 : 0;

        saveToStorage();
        displayResults(categoriesWithBalance, totalIncome, totalAlreadySpent, totalToSave, remainingAfterBasics, distribution);
    }

    function calculateBonus() {
        const bonusAmount = parseInt(document.getElementById('bonusAmount').value);
        if (!bonusAmount || bonusAmount <= 0) {
            alert('–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Å—É–º–º—É –ø—Ä–µ–º–∏–∏');
            return;
        }

        saveToStorage();
        const distribution = bonusAmount / 4;
        const bonusResult = document.getElementById('bonusResult');
        const bonusDistribution = document.getElementById('bonusDistribution');
        
        bonusResult.style.display = 'block';
        bonusDistribution.innerHTML = `
            <div class="category"><span>üíº –û–ø–µ—Ä—Ä–µ–∑–µ—Ä–≤:</span><span>${formatMoney(distribution)}</span></div>
            <div class="category"><span>üìà –î–æ–ª–≥–æ—Å—Ä–æ–∫:</span><span>${formatMoney(distribution)}</span></div>
            <div class="category"><span>üöó –ú–∞—à–∏–Ω–∞:</span><span>${formatMoney(distribution)}</span></div>
            <div class="category"><span>üíé –°–≤–æ–±–æ–¥–Ω—ã–µ:</span><span>${formatMoney(distribution)}</span></div>
            <div class="category" style="background: #e8f5e8;">
                <span><strong>–í—Å–µ–≥–æ –ø—Ä–µ–º–∏–∏:</strong></span><span><strong>${formatMoney(bonusAmount)}</strong></span>
            </div>
        `;
        
        bonusResult.scrollIntoView({ behavior: 'smooth' });
        Telegram.WebApp.showAlert(`–ü—Ä–µ–º–∏—è —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∞! –ü–æ ${formatMoney(distribution)} –≤ –∫–∞–∂–¥—É—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é`);
    }

    function displayResults(categories, totalIncome, totalAlreadySpent, totalToSave, remainingAfterBasics, distribution) {
        const resultDiv = document.getElementById('distributionResult');
        const categoriesList = document.getElementById('categoriesList');
        
        const isOverDistributed = totalAlreadySpent > totalIncome;
        const overAmount = isOverDistributed ? totalAlreadySpent - totalIncome : 0;
        
        resultDiv.style.display = 'block';
        categoriesList.innerHTML = `
            ${isOverDistributed ? `
                <div class="warning-message">
                    ‚ö†Ô∏è –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–æ —Å–≤–µ—Ä—Ö –æ–±—â–µ–π —Å—É–º–º—ã: ${formatMoney(overAmount)}
                </div>
            ` : ''}
            <div class="summary ${isOverDistributed ? 'over-distributed' : ''}">
                <div class="category"><span>üí∞ –û–±—â–∏–π –¥–æ—Ö–æ–¥:</span><span>${formatMoney(totalIncome)}</span></div>
                <div class="category"><span>üí∏ –£–∂–µ –ø–æ—Ç—Ä–∞—á–µ–Ω–æ:</span><span>${formatMoney(totalAlreadySpent)}</span></div>
                <div class="category"><span>üì• –ù—É–∂–Ω–æ –¥–æ–ª–æ–∂–∏—Ç—å –¥–æ –ª–∏–º–∏—Ç–æ–≤:</span><span>${formatMoney(totalToSave)}</span></div>
                <div class="category"><span>üéØ –°–≤–æ–±–æ–¥–Ω—ã–π –æ—Å—Ç–∞—Ç–æ–∫:</span><span>${formatMoney(remainingAfterBasics)}</span></div>
            </div>
            
            <h4>–ë–∞–∑–æ–≤—ã–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ (–õ–∏–º–∏—Ç / –ü–æ—Ç—Ä–∞—á–µ–Ω–æ / –ö –æ—Ç–ª–æ–∂–∏—Ç—å):</h4>
            ${categories.map(cat => `
                <div class="category ${cat.balance >= 0 ? 'balance-positive' : 'balance-negative'}">
                    <span>${cat.name}: ${formatMoney(cat.limit)} / ${formatMoney(cat.spent)}</span>
                    <span>${cat.balance >= 0 ? '‚úÖ' : '‚ùå'} ${formatMoney(cat.toSave)}</span>
                </div>
            `).join('')}
            
            <h4>–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Å–≤–æ–±–æ–¥–Ω—ã—Ö —Å—Ä–µ–¥—Å—Ç–≤:</h4>
            ${distribution > 0 ? `
                <div class="category"><span>üöó –ú–∞—à–∏–Ω–∞:</span><span>${formatMoney(distribution)}</span></div>
                <div class="category"><span>üìà –ò–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏:</span><span>${formatMoney(distribution)}</span></div>
                <div class="category"><span>üíé –°–≤–æ–±–æ–¥–Ω—ã–µ:</span><span>${formatMoney(distribution)}</span></div>
            ` : '<p>‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤ –¥–ª—è —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è</p>'}
        `;
        
        Telegram.WebApp.showAlert(`–†–∞—Å—á–µ—Ç –∑–∞–≤–µ—Ä—à–µ–Ω! –°–≤–æ–±–æ–¥–Ω—ã—Ö —Å—Ä–µ–¥—Å—Ç–≤: ${formatMoney(remainingAfterBasics)}`);
        resultDiv.scrollIntoView({ behavior: 'smooth' });
    }

    function formatMoney(amount) {
        return new Intl.NumberFormat('ru-RU').format(Math.round(amount)) + ' ‚ÇΩ';
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    document.addEventListener('DOMContentLoaded', function() {
        document.getElementById('bonusAmount').addEventListener('input', saveToStorage);
        document.getElementById('totalIncome').addEventListener('input', saveToStorage);
        renderCategories();
        loadFromStorage();
    });

    Telegram.WebApp.onEvent('viewportChanged', saveToStorage);
    Telegram.WebApp.onEvent('closing', saveToStorage);
</script>
