<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Finance Distributor</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            padding: 16px;
            background: #f5f5f5;
        }
        .container {
            max-width: 400px;
            margin: 0 auto;
        }
        .input-group {
            margin-bottom: 20px;
        }
        input {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            box-sizing: border-box;
        }
        button {
            width: 100%;
            padding: 12px;
            background: #2481cc;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            margin-bottom: 10px;
        }
        .category {
            display: flex;
            justify-content: space-between;
            margin: 8px 0;
            padding: 8px;
            background: white;
            border-radius: 6px;
        }
        .result-section {
            margin-top: 20px;
            display: none;
        }
        .category-config {
            background: white;
            padding: 12px;
            margin: 8px 0;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
            position: relative;
        }
        .category-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        .category-name {
            font-weight: bold;
            font-size: 14px;
            flex: 1;
        }
        .category-actions {
            display: flex;
            gap: 8px;
        }
        .category-action {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 16px;
            padding: 4px;
            border-radius: 4px;
            width: auto;
        }
        .category-action.edit {
            color: #2481cc;
        }
        .category-action.delete {
            color: #ff4444;
        }
        .inputs {
            display: flex;
            gap: 12px;
        }
        .input-with-label {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        .input-with-label label {
            font-size: 12px;
            color: #666;
            margin-bottom: 4px;
            font-weight: 500;
        }
        .inputs input {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            width: 100%;
            box-sizing: border-box;
        }
        .balance-positive {
            border-left: 4px solid #4CAF50;
        }
        .balance-negative {
            border-left: 4px solid #f44336;
        }
        .summary .category {
            background: #e8f5e8;
            border-left: 4px solid #4CAF50;
        }
        .reset-button {
            background: #ff4444;
            margin-top: 10px;
        }
        .bonus-section {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border: 1px solid #e0e0e0;
        }
        .bonus-result {
            margin-top: 10px;
            padding: 10px;
            background: #fff3cd;
            border-radius: 6px;
            border: 1px solid #ffeaa7;
        }
        .summary.over-distributed {
            border: 2px solid #f44336;
            border-radius: 8px;
            background: #ffebee;
        }
        .add-category-btn {
            background: #28a745;
            margin-top: 10px;
        }
        .export-button {
            background: #9c27b0;
            margin-top: 10px;
        }
        .copy-button {
            background: #ff9800;
            margin-top: 10px;
        }
        .edit-category-input {
            padding: 6px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            width: 100%;
        }
    </style>
</head>
<body>
    <div class="container">
        <h2>üí∞ –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –¥–æ—Ö–æ–¥–æ–≤</h2>
        
        <div class="input-group">
            <label>–û–±—â–∞—è —Å—É–º–º–∞ –¥–æ—Ö–æ–¥–∞:</label>
            <input type="number" id="totalIncome" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É">
        </div>

        <h3>–ë–∞–∑–æ–≤—ã–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏:</h3>
        <div id="categoriesConfig">
            <!-- –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ –±—É–¥—É—Ç –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è –∑–¥–µ—Å—å -->
        </div>

        <button onclick="addNewCategory()" class="add-category-btn">‚ûï –î–æ–±–∞–≤–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é</button>
        
        <button onclick="calculate()">–†–∞—Å—Å—á–∏—Ç–∞—Ç—å</button>
        
        <!-- –°–µ–∫—Ü–∏—è –¥–ª—è –¥–æ–ø–æ–≤ (–ø—Ä–µ–º–∏–π) -->
        <div class="bonus-section">
            <h3>üéÅ –î–æ–ø—ã (–ø—Ä–µ–º–∏–∏)</h3>
            <div class="input-group">
                <label>–°—É–º–º–∞ –ø—Ä–µ–º–∏–∏:</label>
                <input type="number" id="bonusAmount" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É –ø—Ä–µ–º–∏–∏">
            </div>
            <button onclick="calculateBonus()" style="background: #28a745;">–†–∞—Å—Å—á–∏—Ç–∞—Ç—å –ø—Ä–µ–º–∏—é</button>
            <div id="bonusResult" class="bonus-result" style="display: none;">
                <h4>–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø—Ä–µ–º–∏–∏:</h4>
                <div id="bonusDistribution"></div>
            </div>
        </div>
        
        <button onclick="resetData()" class="reset-button">üîÑ –°–±—Ä–æ—Å–∏—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ</button>
        <button onclick="exportToExcel()" class="export-button">üìä –≠–∫—Å–ø–æ—Ä—Ç –≤ Excel</button>
        <button onclick="copyToClipboard()" class="copy-button">üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –æ—Ç—á–µ—Ç</button>
        
        <div id="distributionResult" class="result-section">
            <h3>–†–µ–∑—É–ª—å—Ç–∞—Ç —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è:</h3>
            <div id="categoriesList"></div>
        </div>
    </div>

    <script>
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram Web App
        Telegram.WebApp.ready();
        Telegram.WebApp.expand();
        Telegram.WebApp.enableClosingConfirmation();
        Telegram.WebApp.setHeaderColor('#2481cc');
        Telegram.WebApp.setBackgroundColor('#f5f5f5');

        // –ë–∞–∑–æ–≤–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è (spent = 0 –∏–∑–Ω–∞—á–∞–ª—å–Ω–æ)
        const defaultConfig = {
            categories: [
                { id: 'house', name: 'üè† –î–æ–º', limit: 10000, spent: 0 },
                { id: 'car', name: 'üöó –ú–∞—à–∏–Ω–∞', limit: 38000, spent: 0 },
                { id: 'longTerm', name: 'üìà –î–æ–ª–≥–æ—Å—Ä–æ–∫', limit: 45000, spent: 0 },
                { id: 'start', name: 'üöÄ –°—Ç–∞—Ä—Ç', limit: 10000, spent: 0 },
                { id: 'oper', name: 'üíº –û–ø–µ—Ä', limit: 45000, spent: 0 },
                { id: 'wife', name: 'üë© –ñ–µ–Ω–∞', limit: 42000, spent: 0 },
                { id: 'free', name: 'üíé –°–≤–æ–±–æ–¥–Ω–æ', limit: 40000, spent: 0 },
                { id: 'hata', name: 'üè° –•–ê–¢–ê', limit: 20000, spent: 0 },
                { id: 'home', name: 'üè† –î–æ–º–æ–π', limit: 10000, spent: 0 }
            ],
            extraReserve: 0
        };

        let config = JSON.parse(JSON.stringify(defaultConfig));

        // –ù–∞–¥–µ–∂–Ω–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
        function saveToStorage() {
            const data = {
                categories: config.categories,
                lastIncome: document.getElementById('totalIncome').value,
                bonusAmount: document.getElementById('bonusAmount').value,
                timestamp: new Date().toISOString(),
                version: '1.3'
            };
            
            try {
                data.categories.forEach((category) => {
                    Telegram.WebApp.CloudStorage.setItem(`cat_${category.id}`, JSON.stringify(category));
                });
                Telegram.WebApp.CloudStorage.setItem('finance_config', JSON.stringify(data));
            } catch (e) {}
            
            try {
                localStorage.setItem('finance_data', JSON.stringify(data));
            } catch (e) {}
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö
        function loadFromStorage() {
            let loadedData = null;
            
            try {
                const localData = localStorage.getItem('finance_data');
                if (localData) {
                    loadedData = JSON.parse(localData);
                    applyLoadedData(loadedData);
                    return;
                }
            } catch (e) {}
            
            console.log('No saved data found, using defaults');
        }

        function applyLoadedData(data) {
            if (data && data.categories) {
                // –ü–æ–ª–Ω–æ—Å—Ç—å—é –∑–∞–º–µ–Ω—è–µ–º –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –Ω–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ
                config.categories = data.categories.map(savedCat => {
                    return {
                        id: savedCat.id,
                        name: savedCat.name,
                        limit: savedCat.limit || defaultConfig.categories.find(c => c.id === savedCat.id)?.limit || 0,
                        spent: savedCat.spent || 0
                    };
                });
                renderCategories();
            }
            if (data && data.lastIncome) {
                document.getElementById('totalIncome').value = data.lastIncome;
            }
            if (data && data.bonusAmount) {
                document.getElementById('bonusAmount').value = data.bonusAmount;
            }
        }

        // –§—É–Ω–∫—Ü–∏—è —Å–±—Ä–æ—Å–∞ –¥–∞–Ω–Ω—ã—Ö
        function resetData() {
            if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —Å–±—Ä–æ—Å–∏—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –∫ –Ω–∞—á–∞–ª—å–Ω—ã–º –∑–Ω–∞—á–µ–Ω–∏—è–º?')) {
                config = JSON.parse(JSON.stringify(defaultConfig));
                document.getElementById('totalIncome').value = '';
                document.getElementById('bonusAmount').value = '';
                document.getElementById('bonusResult').style.display = 'none';
                document.getElementById('distributionResult').style.display = 'none';
                renderCategories();
                saveToStorage();
                Telegram.WebApp.showAlert('–î–∞–Ω–Ω—ã–µ —Å–±—Ä–æ—à–µ–Ω—ã –∫ –Ω–∞—á–∞–ª—å–Ω—ã–º –∑–Ω–∞—á–µ–Ω–∏—è–º');
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        }

        // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
        function addNewCategory() {
            const newId = 'category_' + Date.now();
            const newCategory = {
                id: newId,
                name: 'üÜï –ù–æ–≤–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è',
                limit: 10000,
                spent: 0
            };
            config.categories.push(newCategory);
            renderCategories();
            saveToStorage();
        }

        // –£–¥–∞–ª–µ–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
        function deleteCategory(categoryId) {
            if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç—É –∫–∞—Ç–µ–≥–æ—Ä–∏—é?')) {
                config.categories = config.categories.filter(cat => cat.id !== categoryId);
                renderCategories();
                saveToStorage();
            }
        }

        // –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞–∑–≤–∞–Ω–∏—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
        function editCategoryName(categoryId) {
            const category = config.categories.find(cat => cat.id === categoryId);
            if (!category) return;

            const newName = prompt('–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ (–º–æ–∂–Ω–æ —Å–æ —Å–º–∞–π–ª–∏–∫–æ–º):', category.name);
            if (newName && newName.trim() !== '') {
                category.name = newName.trim();
                renderCategories();
                saveToStorage();
            }
        }

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        function renderCategories() {
            const container = document.getElementById('categoriesConfig');
            let html = '';
            
            config.categories.forEach((category) => {
                html += `
                    <div class="category-config">
                        <div class="category-header">
                            <div class="category-name">${category.name}</div>
                            <div class="category-actions">
                                <button class="category-action edit" onclick="editCategoryName('${category.id}')" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –Ω–∞–∑–≤–∞–Ω–∏–µ">‚úèÔ∏è</button>
                                <button class="category-action delete" onclick="deleteCategory('${category.id}')" title="–£–¥–∞–ª–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é">‚ùå</button>
                            </div>
                        </div>
                        <div class="inputs">
                            <div class="input-with-label">
                                <label>–õ–∏–º–∏—Ç</label>
                                <input type="number" 
                                       id="limit_${category.id}" 
                                       value="${category.limit}" 
                                       placeholder="–õ–∏–º–∏—Ç"
                                       onchange="updateCategory('${category.id}')">
                            </div>
                            <div class="input-with-label">
                                <label>–ü–æ—Ç—Ä–∞—á–µ–Ω–æ</label>
                                <input type="number" 
                                       id="spent_${category.id}" 
                                       value="${category.spent}" 
                                       placeholder="–ü–æ—Ç—Ä–∞—á–µ–Ω–æ"
                                       onchange="updateCategory('${category.id}')">
                            </div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        // –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –ø–æ–ª–µ–π
        function updateCategory(categoryId) {
            const category = config.categories.find(cat => cat.id === categoryId);
            if (category) {
                category.limit = parseInt(document.getElementById(`limit_${categoryId}`).value) || 0;
                category.spent = parseInt(document.getElementById(`spent_${categoryId}`).value) || 0;
                saveToStorage();
            }
        }

        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –ø–æ–ª—è –ø—Ä–µ–º–∏–∏
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('bonusAmount').addEventListener('input', saveToStorage);
            document.getElementById('totalIncome').addEventListener('input', saveToStorage);
        });

        // –§—É–Ω–∫—Ü–∏—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞
        function copyToClipboard() {
            const totalIncome = parseInt(document.getElementById('totalIncome').value) || 0;
            const bonusAmount = parseInt(document.getElementById('bonusAmount').value) || 0;
            
            if (!totalIncome) {
                alert('–°–Ω–∞—á–∞–ª–∞ –≤–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É –¥–æ—Ö–æ–¥–∞ –∏ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ —Ä–∞—Å—á–µ—Ç');
                return;
            }

            // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ
            const categoriesWithBalance = config.categories.map(category => {
                const balance = category.limit - category.spent;
                const toSave = Math.max(0, balance);
                return {
                    ...category,
                    balance: balance,
                    toSave: toSave
                };
            });

            const totalAlreadySpent = config.categories.reduce((sum, cat) => sum + cat.spent, 0);
            const totalToSave = categoriesWithBalance.reduce((sum, cat) => sum + cat.toSave, 0);
            const remainingAfterBasics = (totalIncome - totalAlreadySpent - totalToSave) + config.extraReserve;
            const distribution = remainingAfterBasics > 0 ? remainingAfterBasics / 3 : 0;

            // –§–æ—Ä–º–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è
            let text = `üí∞ –†–ê–°–ü–†–ï–î–ï–õ–ï–ù–ò–ï –§–ò–ù–ê–ù–°–û–í\n`;
            text += `üìÖ ${new Date().toLocaleDateString('ru-RU')}\n\n`;
            
            text += `–û–°–ù–û–í–ù–´–ï –ü–û–ö–ê–ó–ê–¢–ï–õ–ò:\n`;
            text += `‚Ä¢ –û–±—â–∏–π –¥–æ—Ö–æ–¥: ${formatMoney(totalIncome)}\n`;
            text += `‚Ä¢ –£–∂–µ –ø–æ—Ç—Ä–∞—á–µ–Ω–æ: ${formatMoney(totalAlreadySpent)}\n`;
            text += `‚Ä¢ –ö –¥–æ–ø–ª–∞—Ç–µ: ${formatMoney(totalToSave)}\n`;
            text += `‚Ä¢ –°–≤–æ–±–æ–¥–Ω—ã–π –æ—Å—Ç–∞—Ç–æ–∫: ${formatMoney(remainingAfterBasics)}\n\n`;
            
            text += `–ö–ê–¢–ï–ì–û–†–ò–ò:\n`;
            categoriesWithBalance.forEach(cat => {
                const balance = cat.limit - cat.spent;
                const status = balance >= 0 ? '‚úÖ' : '‚ùå';
                const toSaveDisplay = balance >= 0 ? 
                    `+${formatMoney(cat.toSave)}` : 
                    `-${formatMoney(Math.abs(balance))}`;
                
                text += `‚Ä¢ ${cat.name}: ${formatMoney(cat.limit)} / ${formatMoney(cat.spent)} (${status} ${toSaveDisplay})\n`;
            });
            
            text += `\n`;
            
            if (distribution > 0) {
                text += `–†–ê–°–ü–†–ï–î–ï–õ–ï–ù–ò–ï –°–í–û–ë–û–î–ù–´–• –°–†–ï–î–°–¢–í:\n`;
                text += `‚Ä¢ –ú–∞—à–∏–Ω–∞: ${formatMoney(distribution)}\n`;
                text += `‚Ä¢ –ò–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏: ${formatMoney(distribution)}\n`;
                text += `‚Ä¢ –°–≤–æ–±–æ–¥–Ω—ã–µ: ${formatMoney(distribution)}\n\n`;
            }
            
            if (bonusAmount > 0) {
                const bonusDistribution = bonusAmount / 4;
                text += `–ü–†–ï–ú–ò–Ø:\n`;
                text += `‚Ä¢ –°—É–º–º–∞ –ø—Ä–µ–º–∏–∏: ${formatMoney(bonusAmount)}\n`;
                text += `‚Ä¢ –û–ø–µ—Ä—Ä–µ–∑–µ—Ä–≤: ${formatMoney(bonusDistribution)}\n`;
                text += `‚Ä¢ –î–æ–ª–≥–æ—Å—Ä–æ–∫: ${formatMoney(bonusDistribution)}\n`;
                text += `‚Ä¢ –ú–∞—à–∏–Ω–∞: ${formatMoney(bonusDistribution)}\n`;
                text += `‚Ä¢ –°–≤–æ–±–æ–¥–Ω—ã–µ: ${formatMoney(bonusDistribution)}\n\n`;
            }
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–µ—Ä–µ—Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ
            if (totalAlreadySpent > totalIncome) {
                const overAmount = totalAlreadySpent - totalIncome;
                text += `‚ö†Ô∏è –í–ù–ò–ú–ê–ù–ò–ï: –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–æ —Å–≤–µ—Ä—Ö –æ–±—â–µ–π —Å—É–º–º—ã: ${formatMoney(overAmount)}\n\n`;
            }
            
            text += `–°–æ–∑–¥–∞–Ω–æ –≤ Finance Distributor`;

            // –ö–æ–ø–∏—Ä—É–µ–º –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(text).then(() => {
                    Telegram.WebApp.showAlert('‚úÖ –û—Ç—á–µ—Ç —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞!');
                }).catch(() => {
                    fallbackCopy(text);
                });
            } else {
                fallbackCopy(text);
            }
        }

        // Fallback –º–µ—Ç–æ–¥ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è
        function fallbackCopy(text) {
            const textArea = document.createElement('textarea');
            textArea.value = text;
            document.body.appendChild(textArea);
            textArea.select();
            try {
                document.execCommand('copy');
                Telegram.WebApp.showAlert('‚úÖ –û—Ç—á–µ—Ç —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞!');
            } catch (err) {
                Telegram.WebApp.showAlert('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏');
                prompt('–°–∫–æ–ø–∏—Ä—É–π—Ç–µ —ç—Ç–æ—Ç —Ç–µ–∫—Å—Ç:', text);
            }
            document.body.removeChild(textArea);
        }

        // –§—É–Ω–∫—Ü–∏—è —ç–∫—Å–ø–æ—Ä—Ç–∞ –≤ Excel
        function exportToExcel() {
            const totalIncome = parseInt(document.getElementById('totalIncome').value) || 0;
            const bonusAmount = parseInt(document.getElementById('bonusAmount').value) || 0;
            
            // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞
            const categoriesWithBalance = config.categories.map(category => {
                const balance = category.limit - category.spent;
                const toSave = Math.max(0, balance);
                return {
                    ...category,
                    balance: balance,
                    toSave: toSave
                };
            });

            const totalAlreadySpent = config.categories.reduce((sum, cat) => sum + cat.spent, 0);
            const totalToSave = categoriesWithBalance.reduce((sum, cat) => sum + cat.toSave, 0);
            const remainingAfterBasics = (totalIncome - totalAlreadySpent - totalToSave) + config.extraReserve;
            const distribution = remainingAfterBasics > 0 ? remainingAfterBasics / 3 : 0;

            // –°–æ–∑–¥–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è Excel
            const excelData = [];

            // –ó–∞–≥–æ–ª–æ–≤–æ–∫
            excelData.push(['–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ñ–∏–Ω–∞–Ω—Å–æ–≤ –æ—Ç ' + new Date().toLocaleDateString('ru-RU')]);
            excelData.push([]);

            // –û—Å–Ω–æ–≤–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
            excelData.push(['–í—Å–µ–≥–æ –ø—Ä–∏—à–ª–æ', totalIncome, '', '']);
            excelData.push([]);
            excelData.push(['', '–ü–æ—Ç—Ä–∞—á–µ–Ω–æ', '–û—Å—Ç–∞—Ç–æ–∫', '–õ–∏–º–∏—Ç']);

            // –ö–∞—Ç–µ–≥–æ—Ä–∏–∏
            config.categories.forEach(category => {
                const balance = category.limit - category.spent;
                excelData.push([
                    category.name.replace(/[üè†üöóüìàüöÄüíºüë©üíéüè°]/g, '').trim(),
                    category.spent,
                    Math.max(0, balance),
                    category.limit
                ]);
            });

            excelData.push([]);
            excelData.push(['–æ—Å—Ç–∞—Ç–æ–∫', remainingAfterBasics, '', '']);
            excelData.push([]);

            // –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –æ—Å—Ç–∞—Ç–∫–∞
            excelData.push(['—Ä–∞—Å–ø—Ä–µ–¥ –æ—Å—Ç–∞—Ç–æ–∫', '', '–æ—Ç–ª–æ–∂–µ–Ω–æ', '–æ—Å—Ç–∞—Ç–æ–∫', '–ª–∏–º–∏—Ç']);
            excelData.push(['', '–º–∞—à–∏–Ω–∞', distribution, '', distribution]);
            excelData.push(['', '–∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏', distribution, '', distribution]);
            excelData.push(['', '—Å–≤–æ–±–æ–¥–Ω—ã–µ', distribution, '', distribution]);

            excelData.push([]);

            // –ü—Ä–µ–º–∏—è
            if (bonusAmount > 0) {
                const bonusDistribution = bonusAmount / 4;
                excelData.push(['–î–æ–ø—ã (–ø—Ä–µ–º–∏–∏)', '', '', '']);
                excelData.push(['–°—É–º–º–∞ –ø—Ä–µ–º–∏–∏', bonusAmount, '', '']);
                excelData.push(['–û–ø–µ—Ä—Ä–µ–∑–µ—Ä–≤', bonusDistribution, '', '']);
                excelData.push(['–î–æ–ª–≥–æ—Å—Ä–æ–∫', bonusDistribution, '', '']);
                excelData.push(['–ú–∞—à–∏–Ω–∞', bonusDistribution, '', '']);
                excelData.push(['–°–≤–æ–±–æ–¥–Ω—ã–µ', bonusDistribution, '', '']);
            }

            // –°–æ–∑–¥–∞–µ–º –∫–Ω–∏–≥—É Excel
            const ws = XLSX.utils.aoa_to_sheet(excelData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, '–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ');

            // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Ñ–∞–π–ª
            const fileName = `—Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ_—Ñ–∏–Ω–∞–Ω—Å–æ–≤_${new Date().toLocaleDateString('ru-RU').replace(/\./g, '-')}.xlsx`;
            XLSX.writeFile(wb, fileName);

            Telegram.WebApp.showAlert(`–§–∞–π–ª "${fileName}" —Å–æ–∑–¥–∞–Ω!`);
        }

        // –í—Å–µ –æ—Å—Ç–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –æ—Å—Ç–∞—é—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π
        function calculate() {
            const totalIncome = parseInt(document.getElementById('totalIncome').value);
            if (!totalIncome || totalIncome <= 0) {
                alert('–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Å—É–º–º—É –¥–æ—Ö–æ–¥–∞');
                return;
            }

            const categoriesWithBalance = config.categories.map(category => {
                const balance = category.limit - category.spent;
                const toSave = Math.max(0, balance);
                return {
                    ...category,
                    balance: balance,
                    toSave: toSave
                };
            });

            const totalAlreadySpent = config.categories.reduce((sum, cat) => sum + cat.spent, 0);
            const totalToSave = categoriesWithBalance.reduce((sum, cat) => sum + cat.toSave, 0);
            const remainingAfterBasics = (totalIncome - totalAlreadySpent - totalToSave) + config.extraReserve;
            const distribution = remainingAfterBasics > 0 ? remainingAfterBasics / 3 : 0;

            saveToStorage();
            displayResults(categoriesWithBalance, totalIncome, totalAlreadySpent, totalToSave, remainingAfterBasics, distribution);
        }

        function calculateBonus() {
            const bonusAmount = parseInt(document.getElementById('bonusAmount').value);
            if (!bonusAmount || bonusAmount <= 0) {
                alert('–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Å—É–º–º—É –ø—Ä–µ–º–∏–∏');
                return;
            }

            saveToStorage();
            const distribution = bonusAmount / 4;
            const bonusResult = document.getElementById('bonusResult');
            const bonusDistribution = document.getElementById('bonusDistribution');
            
            bonusResult.style.display = 'block';
            bonusDistribution.innerHTML = `
                <div class="category"><span>üíº –û–ø–µ—Ä—Ä–µ–∑–µ—Ä–≤:</span><span>${formatMoney(distribution)}</span></div>
                <div class="category"><span>üìà –î–æ–ª–≥–æ—Å—Ä–æ–∫:</span><span>${formatMoney(distribution)}</span></div>
                <div class="category"><span>üöó –ú–∞—à–∏–Ω–∞:</span><span>${formatMoney(distribution)}</span></div>
                <div class="category"><span>üíé –°–≤–æ–±–æ–¥–Ω—ã–µ:</span><span>${formatMoney(distribution)}</span></div>
                <div class="category" style="background: #e8f5e8;"><span><strong>–í—Å–µ–≥–æ –ø—Ä–µ–º–∏–∏:</strong></span><span><strong>${formatMoney(bonusAmount)}</strong></span></div>
            `;
            
            bonusResult.scrollIntoView({ behavior: 'smooth', block: 'start' });
            Telegram.WebApp.showAlert(`–ü—Ä–µ–º–∏—è —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∞! –ü–æ ${formatMoney(distribution)} –≤ –∫–∞–∂–¥—É—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é`);
        }

        function displayResults(categories, totalIncome, totalAlreadySpent, totalToSave, remainingAfterBasics, distribution) {
            const resultDiv = document.getElementById('distributionResult');
            const categoriesList = document.getElementById('categoriesList');
            
            resultDiv.style.display = 'block';

            const isOverDistributed = totalAlreadySpent > totalIncome;
            const overAmount = isOverDistributed ? totalAlreadySpent - totalIncome : 0;
            
            let warningHtml = '';
            if (isOverDistributed) {
                warningHtml = `
                    <div style="color: #d32f2f; background: #ffebee; padding: 10px; border-radius: 6px; border: 1px solid #ffcdd2; margin-bottom: 15px; font-size: 14px;">
                        ‚ö†Ô∏è –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–æ —Å–≤–µ—Ä—Ö –æ–±—â–µ–π —Å—É–º–º—ã: ${formatMoney(overAmount)}
                    </div>
                `;
            }

            let html = warningHtml +  `
                <div class="summary ${isOverDistributed ? 'over-distributed' : ''}">
                    <div class="category"><span>üí∞ –û–±—â–∏–π –¥–æ—Ö–æ–¥:</span><span>${formatMoney(totalIncome)}</span></div>
                    <div class="category"><span>üí∏ –£–∂–µ –ø–æ—Ç—Ä–∞—á–µ–Ω–æ:</span><span>${formatMoney(totalAlreadySpent)}</span></div>
                    <div class="category"><span>üì• –ù—É–∂–Ω–æ –¥–æ–ª–æ–∂–∏—Ç—å –¥–æ –ª–∏–º–∏—Ç–æ–≤:</span><span>${formatMoney(totalToSave)}</span></div>
                    <div class="category"><span>üéØ –°–≤–æ–±–æ–¥–Ω—ã–π –æ—Å—Ç–∞—Ç–æ–∫:</span><span>${formatMoney(remainingAfterBasics)}</span></div>
                </div>
                
                <h4>–ë–∞–∑–æ–≤—ã–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ (–õ–∏–º–∏—Ç / –ü–æ—Ç—Ä–∞—á–µ–Ω–æ / –ö –æ—Ç–ª–æ–∂–∏—Ç—å):</h4>
            `;
            
            categories.forEach(cat => {
                const balance = cat.limit - cat.spent;
                const status = balance >= 0 ? '‚úÖ' : '‚ùå';
                const balanceClass = balance >= 0 ? 'balance-positive' : 'balance-negative';
                const toSaveDisplay = balance >= 0 ? 
                    formatMoney(cat.toSave) : 
                    `<span style="color: #d32f2f;">- ${formatMoney(Math.abs(balance))}</span>`;
                
                html += `
                    <div class="category ${balanceClass}">
                        <span>${cat.name}: ${formatMoney(cat.limit)} / ${formatMoney(cat.spent)}</span>
                        <span>${status} ${toSaveDisplay}</span>
                    </div>
                `;
            });
            
            html += `<h4>–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Å–≤–æ–±–æ–¥–Ω—ã—Ö —Å—Ä–µ–¥—Å—Ç–≤:</h4>`;
            
            if (distribution > 0) {
                html += `
                    <div class="category"><span>üöó –ú–∞—à–∏–Ω–∞:</span><span>${formatMoney(distribution)}</span></div>
                    <div class="category"><span>üìà –ò–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏:</span><span>${formatMoney(distribution)}</span></div>
                    <div class="category"><span>üíé –°–≤–æ–±–æ–¥–Ω—ã–µ:</span><span>${formatMoney(distribution)}</span></div>
                `;
            } else {
                html += `<p>‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤ –¥–ª—è —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è</p>`;
            }
            
            categoriesList.innerHTML = html;
            Telegram.WebApp.showAlert(`–†–∞—Å—á–µ—Ç –∑–∞–≤–µ—Ä—à–µ–Ω! –°–≤–æ–±–æ–¥–Ω—ã—Ö —Å—Ä–µ–¥—Å—Ç–≤: ${formatMoney(remainingAfterBasics)}`);
            resultDiv.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        function formatMoney(amount) {
            return new Intl.NumberFormat('ru-RU').format(Math.round(amount)) + ' ‚ÇΩ';
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        renderCategories();
        loadFromStorage();
        
        Telegram.WebApp.onEvent('viewportChanged', saveToStorage);
        Telegram.WebApp.onEvent('closing', saveToStorage);
    </script>
</body>
</html>
